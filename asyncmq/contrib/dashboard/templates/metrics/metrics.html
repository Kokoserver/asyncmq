{% extends "layout.html" %}
{% block content %}
  <h1 class="text-2xl font-bold mb-4">Metrics</h1>

  <div class="grid grid-cols-4 gap-4 mb-6">
    <div class="p-4 bg-white rounded shadow">
      <h2>Throughput</h2>
      <div id="throughput" class="text-3xl font-bold">{{ metrics.throughput }}</div>
    </div>
    <div class="p-4 bg-white rounded shadow">
      <h2>Avg Duration</h2>
      <div id="avg-duration" class="text-3xl font-bold">{{ metrics.avg_duration or "—" }}</div>
    </div>
    <div class="p-4 bg-white rounded shadow">
      <h2>Retries</h2>
      <div id="retries" class="text-3xl font-bold">{{ metrics.retries }}</div>
    </div>
    <div class="p-4 bg-white rounded shadow">
      <h2>Failures</h2>
      <div id="failures" class="text-3xl font-bold">{{ metrics.failures }}</div>
    </div>
  </div>

  <h2 class="text-xl font-semibold mb-2">Metrics Over Time</h2>
  <canvas id="metrics-chart" class="mb-6" height="100"></canvas>

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('metrics-chart').getContext('2d');
    const maxPoints = 20;
    const chartData = {
      labels: [],
      datasets: [
        { label: 'Throughput', data: [] },
        { label: 'Retries',    data: [] },
        { label: 'Failures',   data: [] },
      ]
    };
    const metricsChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        scales: { x: { display: true }, y: { beginAtZero: true } },
        animation: { duration: 0 },
      }
    });

    const source = new EventSource('/events');
    source.addEventListener('metrics', e => {
      try {
        const m = JSON.parse(e.data);
        const ts = new Date().toLocaleTimeString();

        // update cards
        document.getElementById('throughput').textContent   = m.throughput;
        document.getElementById('avg-duration').textContent = m.avg_duration ?? '—';
        document.getElementById('retries').textContent      = m.retries;
        document.getElementById('failures').textContent     = m.failures;

        // push to chart
        chartData.labels.push(ts);
        chartData.datasets[0].data.push(m.throughput);
        chartData.datasets[1].data.push(m.retries);
        chartData.datasets[2].data.push(m.failures);

        // trim old points
        if (chartData.labels.length > maxPoints) {
          chartData.labels.shift();
          chartData.datasets.forEach(ds => ds.data.shift());
        }
        metricsChart.update();
      } catch (err) {
        console.error('Metrics SSE parse error', err);
      }
    });

    source.onerror = () => console.warn('SSE error on metrics – retrying');
  </script>
{% endblock %}
