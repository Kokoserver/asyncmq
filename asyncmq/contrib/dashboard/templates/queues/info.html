{% extends "layout.html" %}
{% block content %}
  <h1 class="text-3xl font-semibold mb-6">Queue “{{ queue }}” Details</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Controls & Counts Card -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold mb-4">Controls</h2>
      <form method="post" class="mb-6">
        {% if paused %}
          <button name="action" value="resume"
                  class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            Resume Queue
          </button>
        {% else %}
          <button name="action" value="pause"
                  class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
            Pause Queue
          </button>
        {% endif %}
      </form>

      <h2 class="text-lg font-semibold mb-4">Job Counts</h2>
      <div class="grid grid-cols-2 gap-4">
        <div class="flex justify-between">
          <span class="font-medium text-gray-700">Waiting:</span>
          <span class="text-gray-900">{{ counts.waiting }}</span>
        </div>
        <div class="flex justify-between">
          <span class="font-medium text-gray-700">Active:</span>
          <span class="text-gray-900">{{ counts.active }}</span>
        </div>
        <div class="flex justify-between">
          <span class="font-medium text-gray-700">Delayed:</span>
          <span class="text-gray-900">{{ counts.delayed }}</span>
        </div>
        <div class="flex justify-between">
          <span class="font-medium text-gray-700">Failed:</span>
          <span class="text-red-600">{{ counts.failed }}</span>
        </div>
        <div class="flex justify-between col-span-2">
          <span class="font-medium text-gray-700">Completed:</span>
          <span class="text-green-600">{{ counts.completed }}</span>
        </div>
      </div>
    </div>

    <!-- Real-Time Chart Card -->
    <div class="bg-white rounded-lg shadow p-6 flex flex-col">
      <h2 class="text-lg font-semibold mb-4">Real-Time Job Counts</h2>
      <div class="flex-1 h-64">
        <canvas id="queue-chart" class="w-full h-full"></canvas>
      </div>
    </div>
  </div>

  <!-- Quick Links Card -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Quick Links</h2>
    <ul class="grid grid-cols-1 sm:grid-cols-2 gap-2">
      <li>
        <a href="{{ url_prefix }}/queues/{{ queue }}/jobs"
           class="text-indigo-600 hover:text-indigo-800">
          • All Jobs
        </a>
      </li>
      <li>
        <a href="{{ url_prefix }}/queues/{{ queue }}/repeatables"
           class="text-indigo-600 hover:text-indigo-800">
          • Repeatables
        </a>
      </li>
      <li>
        <a href="{{ url_prefix }}/queues/{{ queue }}/dlq"
           class="text-indigo-600 hover:text-indigo-800">
          • Dead-Letter Queue
        </a>
      </li>
    </ul>
  </div>

  <!-- Chart.js CDN + SSE Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('queue-chart').getContext('2d');
    const maxPoints = 20;
    const data = {
      labels: [],
      datasets: [
        { label: 'Waiting',   data: [], borderColor: 'rgba(59,130,246,0.8)', fill: false },
        { label: 'Active',    data: [], borderColor: 'rgba(234,179,8,0.8)',  fill: false },
        { label: 'Delayed',   data: [], borderColor: 'rgba(14,165,233,0.8)', fill: false },
        { label: 'Failed',    data: [], borderColor: 'rgba(239,68,68,0.8)',  fill: false },
        { label: 'Completed', data: [], borderColor: 'rgba(34,197,94,0.8)',  fill: false },
      ]
    };
    const queueChart = new Chart(ctx, {
      type: 'line',
      data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: {}, y: { beginAtZero: true } },
        animation: { duration: 0 },
      },
    });

    const source = new EventSource('{{ url_prefix }}/events');
    source.addEventListener('queues', e => {
      try {
        const rows = JSON.parse(e.data);
        const now = new Date().toLocaleTimeString();
        const q = rows.find(r => r.name === "{{ queue }}");
        if (!q) return;

        data.labels.push(now);
        data.datasets[0].data.push(q.waiting);
        data.datasets[1].data.push(q.active);
        data.datasets[2].data.push(q.delayed);
        data.datasets[3].data.push(q.failed);
        data.datasets[4].data.push(q.completed);

        if (data.labels.length > maxPoints) {
          data.labels.shift();
          data.datasets.forEach(ds => ds.data.shift());
        }
        queueChart.update();
      } catch (err) {
        console.error('Queue SSE parse error', err);
      }
    });
    source.onerror = () => console.warn('SSE error on queues – retrying…');
  </script>
{% endblock %}
